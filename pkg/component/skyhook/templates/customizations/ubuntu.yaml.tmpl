# Skyhook Ubuntu Node Customization
# Generated by CNS Eidos
#
# This customization configures GPU nodes with:
# - GRUB parameters for hugepages and nokaslr
# - Containerd service limits
# - Sysctl kernel tuning parameters
---
apiVersion: skyhook.nvidia.com/v1alpha1
kind: Skyhook
metadata:
  labels:
    app.kubernetes.io/part-of: skyhook-operator
    app.kubernetes.io/created-by: skyhook-operator
    app.kubernetes.io/managed-by: eidos
    app.kubernetes.io/version: "{{ .Script.Version }}"
  name: ubuntu
  namespace: {{ .Script.Namespace }}
spec:
  runtimeRequired: true
{{- if .Tolerations }}
  additionalTolerations:
  {{- range .Tolerations }}
    - {{- if .key }}
      key: {{ .key }}
      {{- end }}
      {{- if .operator }}
      operator: {{ .operator }}
      {{- end }}
      {{- if .value }}
      value: {{ .value }}
      {{- end }}
      {{- if .effect }}
      effect: {{ .effect }}
      {{- end }}
  {{- end }}
{{- else }}
  additionalTolerations:
    - key: dedicated
      operator: Exists
{{- end }}
  interruptionBudget:
    percent: 100
{{- if .NodeSelectorExpressions }}
  nodeSelectors:
    matchExpressions:
    {{- range .NodeSelectorExpressions }}
      - key: {{ .key }}
        operator: {{ .operator }}
        values:
        {{- range .values }}
          - {{ . }}
        {{- end }}
    {{- end }}
{{- end }}
  packages:
    tuning:
      configInterrupts:
        grub.conf:
          type: reboot
        service_containerd.conf:
          type: service
          services: ["containerd"]
        sysctl.conf:
          type: reboot
      interrupt: 
        type: reboot
      configMap:
        grub.conf: |-
          hugepagesz=1G
          hugepages=2
          hugepagesz=2M
          hugepages=5128
          nokaslr
        service_containerd.conf: |-
          [Service]
          LimitSTACK=67108864
        sysctl.conf: |-
          fs.inotify.max_user_instances=65535
          fs.inotify.max_user_watches=524288
          kernel.threads-max=16512444
          vm.max_map_count=262144
          vm.min_free_kbytes=65536
          vm.overcommit_memory=1
