# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: 'Deploy to Cloud Run'
description: 'Copy image to Artifact Registry and deploy to Cloud Run'

inputs:
  project_id:
    description: 'GCP project id'
    required: true
  workload_identity_provider:
    description: 'Workload Identity Provider resource name'
    required: true
  service_account:
    description: 'GCP service account email (or name@project.iam.gserviceaccount.com)'
    required: true
  region:
    description: 'Cloud Run region'
    required: true
  service:
    description: 'Cloud Run service name'
    required: true
  source_image:
    description: 'Source container image to copy (e.g., ghcr.io/nvidia/eidosd:v1.0.0)'
    required: true
  target_registry:
    description: 'Target Artifact Registry path (e.g., us-west1-docker.pkg.dev/project/repo)'
    required: true
  image_name:
    description: 'Image name in target registry (e.g., eidosd)'
    required: false
    default: 'eidosd'

runs:
  using: 'composite'
  steps:
    - name: Validate inputs
      shell: bash
      env:
        PROJECT_ID: ${{ inputs.project_id }}
        WORKLOAD_IDENTITY_PROVIDER: ${{ inputs.workload_identity_provider }}
        SERVICE_ACCOUNT: ${{ inputs.service_account }}
        REGION: ${{ inputs.region }}
        SERVICE: ${{ inputs.service }}
        SOURCE_IMAGE: ${{ inputs.source_image }}
        TARGET_REGISTRY: ${{ inputs.target_registry }}
      run: |
        set -euo pipefail
        [[ -n "$PROJECT_ID" ]] || { echo "::error::project_id is required"; exit 1; }
        [[ -n "$WORKLOAD_IDENTITY_PROVIDER" ]] || { echo "::error::workload_identity_provider is required"; exit 1; }
        [[ -n "$SERVICE_ACCOUNT" ]] || { echo "::error::service_account is required"; exit 1; }
        [[ -n "$REGION" ]] || { echo "::error::region is required"; exit 1; }
        [[ -n "$SERVICE" ]] || { echo "::error::service is required"; exit 1; }
        [[ -n "$SOURCE_IMAGE" ]] || { echo "::error::source_image is required"; exit 1; }
        [[ -n "$TARGET_REGISTRY" ]] || { echo "::error::target_registry is required"; exit 1; }

    - name: Get Auth Token
      id: auth
      uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093  # v3
      with:
        token_format: access_token
        project_id: ${{ inputs.project_id }}
        workload_identity_provider: ${{ inputs.workload_identity_provider }}
        service_account: ${{ inputs.service_account }}

    - name: Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db  # v3.0.1

    - name: Configure Docker for Artifact Registry
      shell: bash
      env:
        TARGET_REGISTRY: ${{ inputs.target_registry }}
      run: |
        # Extract hostname from target registry (e.g., us-docker.pkg.dev/project/repo -> us-docker.pkg.dev)
        REGISTRY_HOST="${TARGET_REGISTRY%%/*}"
        gcloud auth configure-docker "${REGISTRY_HOST}" --quiet

    - name: Install crane
      shell: bash
      run: |
        set -euo pipefail
        CRANE_VERSION="0.20.6"
        CRANE_URL="https://github.com/google/go-containerregistry/releases/download/v${CRANE_VERSION}/go-containerregistry_Linux_x86_64.tar.gz"
        CRANE_TMP="$(mktemp -d)"
        curl -fsSL "$CRANE_URL" | tar -xzC "$CRANE_TMP"
        sudo mv "$CRANE_TMP/crane" /usr/local/bin/crane
        sudo chmod +x /usr/local/bin/crane
        rm -rf "$CRANE_TMP"

    - name: Copy image to Artifact Registry
      id: copy
      shell: bash
      env:
        SOURCE_IMAGE: ${{ inputs.source_image }}
        TARGET_REGISTRY: ${{ inputs.target_registry }}
        IMAGE_NAME: ${{ inputs.image_name }}
      run: |
        set -euo pipefail

        # Extract tag from source image
        TAG="${SOURCE_IMAGE##*:}"
        TARGET_IMAGE="${TARGET_REGISTRY}/${IMAGE_NAME}:${TAG}"

        echo "Copying image..."
        echo "  Source: ${SOURCE_IMAGE}"
        echo "  Target: ${TARGET_IMAGE}"

        crane copy "${SOURCE_IMAGE}" "${TARGET_IMAGE}"

        echo "Image copied successfully"
        echo "target_image=${TARGET_IMAGE}" >> "$GITHUB_OUTPUT"

    - name: Update Cloud Run service image
      shell: bash
      run: |
        set -euo pipefail
        echo "Deploying to Cloud Run..."
        gcloud run services update "${{ inputs.service }}" \
          --image "${{ steps.copy.outputs.target_image }}" \
          --region "${{ inputs.region }}" \
          --project "${{ inputs.project_id }}"
        echo "Deploy complete."
