#!/bin/bash
# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# =============================================================================
# Generate Flox manifest.toml from .versions.yaml
# =============================================================================
#
# This script generates a Flox manifest.toml that installs the same tool
# versions defined in .versions.yaml, providing an alternative to the
# make-based setup for developers who prefer Flox/Nix environments.
#
# Usage:
#   ./tools/generate-flox-manifest
#   make flox-manifest
#
# After generation:
#   flox activate
#
# =============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
VERSIONS_FILE="${ROOT_DIR}/.versions.yaml"
MANIFEST_FILE="${ROOT_DIR}/.flox/env/manifest.toml"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Check for yq
if ! command -v yq &> /dev/null; then
    log_error "yq is required but not installed. Install with: brew install yq"
    exit 1
fi

# Check versions file exists
if [[ ! -f "$VERSIONS_FILE" ]]; then
    log_error "Versions file not found: $VERSIONS_FILE"
    exit 1
fi

log_info "Reading versions from $VERSIONS_FILE"

# Extract versions (strip 'v' prefix where present)
GO_VERSION=$(yq '.languages.go' "$VERSIONS_FILE")
KUBECTL_VERSION=$(yq '.testing_tools.kubectl' "$VERSIONS_FILE" | sed 's/^v//')
KIND_VERSION=$(yq '.testing_tools.kind' "$VERSIONS_FILE" | sed 's/^v//')
HELM_VERSION=$(yq '.testing_tools.helm' "$VERSIONS_FILE" | sed 's/^v//')
KO_VERSION=$(yq '.build_tools.ko' "$VERSIONS_FILE" | sed 's/^v//')
GORELEASER_VERSION=$(yq '.build_tools.goreleaser' "$VERSIONS_FILE" | sed 's/^v//')
GOLANGCI_LINT_VERSION=$(yq '.linting.golangci_lint' "$VERSIONS_FILE" | sed 's/^v//')
YAMLLINT_VERSION=$(yq '.linting.yamllint' "$VERSIONS_FILE" | sed 's/^v//')
TILT_VERSION=$(yq '.testing_tools.tilt' "$VERSIONS_FILE" | sed 's/^v//')
CTLPTL_VERSION=$(yq '.testing_tools.ctlptl' "$VERSIONS_FILE" | sed 's/^v//')

# Create manifest directory if needed
mkdir -p "$(dirname "$MANIFEST_FILE")"

log_info "Generating Flox manifest: $MANIFEST_FILE"

cat > "$MANIFEST_FILE" << EOF
# =============================================================================
# Flox Environment Manifest
# =============================================================================
#
# AUTO-GENERATED from .versions.yaml - DO NOT EDIT DIRECTLY
#
# Regenerate with: make flox-manifest
#
# This provides an alternative to 'make tools-setup' for developers who
# prefer Flox/Nix-based development environments.
#
# Usage:
#   flox activate    # Enter the development environment
#   flox install     # Install packages without activating
#
# =============================================================================

version = 1

# Core development tools
[install]
# Language runtime
go.pkg-path = "go"

# Kubernetes tools
kubectl.pkg-path = "kubectl"
kind.pkg-path = "kind"
helm.pkg-path = "kubernetes-helm"

# Build tools
ko.pkg-path = "ko"
goreleaser.pkg-path = "goreleaser"

# Linting
golangci-lint.pkg-path = "golangci-lint"
yamllint.pkg-path = "yamllint"

# Development utilities
yq.pkg-path = "yq-go"
jq.pkg-path = "jq"
curl.pkg-path = "curl"

# Container tools (tilt and ctlptl may need manual install)
# tilt.pkg-path = "tilt"  # May not be in nixpkgs

[vars]
# Project-specific environment variables
EIDOS_DEV = "true"

[hook]
on-activate = '''
# =============================================================================
# Flox Environment Activation Hook
# =============================================================================

echo ""
echo "Eidos Development Environment (Flox)"
echo "====================================="
echo ""

# Version information from .versions.yaml
echo "Configured versions (.versions.yaml):"
echo "  Go:             ${GO_VERSION}"
echo "  kubectl:        ${KUBECTL_VERSION}"
echo "  kind:           ${KIND_VERSION}"
echo "  Helm:           ${HELM_VERSION}"
echo "  ko:             ${KO_VERSION}"
echo "  goreleaser:     ${GORELEASER_VERSION}"
echo "  golangci-lint:  ${GOLANGCI_LINT_VERSION}"
echo "  yamllint:       ${YAMLLINT_VERSION}"
echo ""

# Verify key tools are available
echo "Installed tools:"
if command -v go &> /dev/null; then
    echo "  go:             \$(go version | awk '{print \$3}')"
else
    echo "  go:             NOT FOUND"
fi

if command -v kubectl &> /dev/null; then
    echo "  kubectl:        \$(kubectl version --client -o json 2>/dev/null | jq -r '.clientVersion.gitVersion' 2>/dev/null || echo 'unknown')"
else
    echo "  kubectl:        NOT FOUND"
fi

if command -v helm &> /dev/null; then
    echo "  helm:           \$(helm version --short 2>/dev/null || echo 'unknown')"
else
    echo "  helm:           NOT FOUND"
fi

if command -v ko &> /dev/null; then
    echo "  ko:             \$(ko version 2>/dev/null || echo 'unknown')"
else
    echo "  ko:             NOT FOUND"
fi

if command -v golangci-lint &> /dev/null; then
    echo "  golangci-lint:  \$(golangci-lint --version 2>/dev/null | head -1 | awk '{print \$4}')"
else
    echo "  golangci-lint:  NOT FOUND"
fi

echo ""

# Check for tools that may need manual installation
MISSING_TOOLS=()
if ! command -v tilt &> /dev/null; then
    MISSING_TOOLS+=("tilt")
fi
if ! command -v ctlptl &> /dev/null; then
    MISSING_TOOLS+=("ctlptl")
fi

if [[ \${#MISSING_TOOLS[@]} -gt 0 ]]; then
    echo "Note: Some tools may need manual installation:"
    for tool in "\${MISSING_TOOLS[@]}"; do
        echo "  - \$tool (run: make tools-setup to install)"
    done
    echo ""
fi

echo "Run 'make tools-check' to verify all versions match .versions.yaml"
echo ""
'''

[profile]
common = '''
# Common shell profile settings
export GOPATH="\${HOME}/go"
export PATH="\${GOPATH}/bin:\${PATH}"
'''
EOF

log_info "Manifest generated successfully"
echo ""
echo "Expected versions (from .versions.yaml):"
echo "  Go:             ${GO_VERSION}"
echo "  kubectl:        ${KUBECTL_VERSION}"
echo "  kind:           ${KIND_VERSION}"
echo "  Helm:           ${HELM_VERSION}"
echo "  ko:             ${KO_VERSION}"
echo "  goreleaser:     ${GORELEASER_VERSION}"
echo "  golangci-lint:  ${GOLANGCI_LINT_VERSION}"
echo "  yamllint:       ${YAMLLINT_VERSION}"
echo "  tilt:           ${TILT_VERSION}"
echo "  ctlptl:         ${CTLPTL_VERSION}"
echo ""
log_warn "Note: Flox/Nix may install slightly different patch versions."
log_warn "Some tools (tilt, ctlptl) may need 'make tools-setup' for exact versions."
echo ""
log_info "To use: flox activate"
