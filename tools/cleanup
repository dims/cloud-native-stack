#!/bin/bash
set -euo pipefail

# Dir setup
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
. "${DIR}/common"
ROOT=$(dirname "${DIR}")

# Check required tools
has_tools kubectl

# Prompt user to confirm cleanup
read -p "Are you sure you want to clean up CNS resources? (y/N): " confirm
if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
    echo "Cleanup aborted."
    exit 0
fi

msg "Cleaning up CNS resources..."

# Delete CNS Kubernetes resources, don't fail if they don't exist
kubectl -n gpu-operator delete job cns || true
kubectl -n gpu-operator delete sa cns || true
kubectl -n gpu-operator delete role cns || true
kubectl -n gpu-operator delete rolebinding cns || true
kubectl delete clusterrole cns || true
kubectl delete clusterrolebinding cns || true

msg "CNS resources cleanup complete."