# Tiltfile for Eidos local development
#
# Usage:
#   tilt up -f tilt/Tiltfile
#
# Or use Makefile targets:
#   make tilt-up
#   make dev-env (creates cluster + starts Tilt)

# Allow deploying to kind-eidos cluster
allow_k8s_contexts('kind-kind-eidos')

# Deploy namespace and RBAC first
k8s_yaml('k8s/namespace.yaml')
k8s_yaml('k8s/rbac.yaml')
k8s_yaml('k8s/service.yaml')
k8s_yaml('k8s/deployment.yaml')

# Build eidosd using ko for fast Go builds
custom_build(
    'localhost:5001/eidosd',
    '../tools/ko-tilt-build ../cmd/eidosd $EXPECTED_REF',
    deps=['../cmd/eidosd', '../pkg'],
    skips_local_docker=True,
)

# Configure the eidosd resource
k8s_resource(
    'eidosd',
    port_forwards=[
        port_forward(8080, 8080, name='API'),
        port_forward(9090, 9090, name='Metrics'),
    ],
    labels=['api'],
)
